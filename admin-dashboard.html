<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© ÙˆØ°ÙƒØ± | Ø§Ù„Ù‚Ø§Ø¦Ø¯</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2e7d32; --bg: #0f172a; --card: #1e293b; --text: #ffffff;
            --accent: #3b82f6; --danger: #ef4444; --glass: rgba(30, 41, 59, 0.7);
        }
        body { font-family: 'Cairo', sans-serif; background: var(--bg); color: var(--text); margin: 0; overflow-x: hidden; }
        
        /* Navbar */
        .navbar {
            position: fixed; top: 0; left: 0; right: 0; height: 70px;
            background: var(--glass); backdrop-filter: blur(15px);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 1000; border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .admin-profile { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .admin-profile img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--primary); }
        
        .settings-trigger {
            width: 45px; height: 45px; display: grid; place-items: center;
            background: var(--primary); border-radius: 12px; cursor: pointer; transition: 0.3s;
        }
        .settings-trigger:hover { transform: rotate(90deg); }

        /* Bottom Sheet Menu */
        .bottom-sheet {
            position: fixed; bottom: -100%; left: 0; right: 0;
            background: var(--card); border-radius: 30px 30px 0 0;
            padding: 30px; z-index: 2000; transition: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
        }
        .bottom-sheet.active { bottom: 0; }
        .sheet-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7);
            display: none; z-index: 1999; backdrop-filter: blur(5px);
        }
        .menu-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .menu-item {
            background: rgba(255,255,255,0.05); padding: 20px; border-radius: 20px;
            text-align: center; cursor: pointer; transition: 0.3s; border: 1px solid rgba(255,255,255,0.05);
        }
        .menu-item:hover { background: var(--primary); }
        .menu-item i { font-size: 24px; margin-bottom: 10px; display: block; }

        /* Sections */
        .container { padding: 90px 20px 30px; max-width: 1100px; margin: auto; }
        .section { display: none; animation: fadeInUp 0.5s ease; }
        .section.active { display: block; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        /* Home Dashboard */
        .hero-card {
            background: linear-gradient(135deg, var(--primary), #1b5e20);
            padding: 30px; border-radius: 30px; margin-bottom: 25px;
        }
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .s-box { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 20px; text-align: center; }

        /* Inputs & Buttons */
        .glass-input {
            width: 100%; padding: 15px; background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 15px;
            color: white; margin-bottom: 15px; font-family: inherit;
        }
        .main-btn {
            width: 100%; padding: 18px; border: none; border-radius: 18px;
            background: var(--primary); color: white; font-weight: 900; cursor: pointer;
        }

        /* Users & Notifs List */
        .data-card {
            background: var(--card); padding: 15px; border-radius: 20px;
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.05);
        }
        .user-meta { display: flex; align-items: center; gap: 12px; }
        .user-meta img { width: 50px; height: 50px; border-radius: 15px; object-fit: cover; }
        
        .badge { padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: bold; }
        .badge-all { background: #3b82f6; }
        .badge-award { background: #f59e0b; }
        .badge-sys { background: #10b981; }

        /* Lock Toggle */
        .lock-btn { background: var(--danger) !important; margin-top: 10px; }
        .lock-active { background: #fbbf24 !important; }
    </style>
</head>
<body>

<div class="sheet-overlay" id="overlay" onclick="closeMenu()"></div>

<nav class="navbar">
    <div class="admin-profile" onclick="showTab('dashboard')">
        <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Omar">
        <div>
            <div style="font-weight: 900; line-height: 1;">Ø¹Ù…Ø±</div>
            <small style="opacity: 0.6;">Ø§Ù„Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ø¹Ø§Ù…</small>
        </div>
    </div>
    <div class="settings-trigger" onclick="openMenu()"><i class="fas fa-cog"></i></div>
</nav>

<div class="bottom-sheet" id="bottomSheet">
    <div style="width: 50px; height: 5px; background: rgba(255,255,255,0.2); border-radius: 10px; margin: 0 auto 25px;"></div>
    <div class="menu-grid">
        <div class="menu-item" onclick="showTab('dashboard')"><i class="fas fa-th-large"></i>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="menu-item" onclick="showTab('notifs')"><i class="fas fa-bell"></i>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</div>
        <div class="menu-item" onclick="showTab('users')"><i class="fas fa-users"></i>Ø§Ù„Ø·Ù„Ø§Ø¨</div>
        <div class="menu-item" onclick="togglePlatform()"><i class="fas fa-power-off"></i><span id="lockText">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ù†ØµØ©</span></div>
        <div class="menu-item" onclick="location.reload()"><i class="fas fa-sync"></i>ØªØ­Ø¯ÙŠØ«</div>
        <div class="menu-item" onclick="logout()" style="color:var(--danger)"><i class="fas fa-sign-out-alt"></i>Ø®Ø±ÙˆØ¬</div>
    </div>
</div>

<div class="container">
    <section id="dashboardSection" class="section active">
        <div class="hero-card">
            <h1 style="margin: 0;">Ø£Ù‡Ù„Ø§Ù‹ ÙŠØ§ Ø¹Ù…Ø± ğŸŒ¿</h1>
            <p id="currentDate"></p>
            <div class="stats-row">
                <div class="s-box"><strong>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</strong><div id="uCount" style="font-size: 24px; font-weight: 900;">0</div></div>
                <div class="s-box"><strong>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</strong><div id="nCount" style="font-size: 24px; font-weight: 900;">0</div></div>
            </div>
        </div>
    </section>

    <section id="notifsSection" class="section">
        <h2>Ø¨Ø« Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h2>
        <div style="background: var(--card); padding: 20px; border-radius: 25px; margin-bottom: 30px;">
            <label>Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø«:</label>
            <select class="glass-input" id="nType" onchange="toggleTargeting()">
                <option value="all">Ø¨Ø« Ø¹Ø§Ù… (Ù„Ù„ÙƒÙ„)</option>
                <option value="award">Ø¬Ø§Ø¦Ø²Ø© Ù…Ø®ØµØµØ© (Ø®Ø§Øµ)</option>
                <option value="system">ØªÙ†Ø¨ÙŠÙ‡ Ù†Ø¸Ø§Ù… (Ø¥Ø¯Ø§Ø±ÙŠ)</option>
            </select>

            <div id="targeting" style="display:none; padding:15px; background:rgba(255,255,255,0.05); border-radius:15px; margin-bottom:15px;">
                <p style="margin-top:0;">ğŸ¯ Ù…Ø³ØªÙ‡Ø¯Ù: <b id="targetName">Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯</b></p>
                <button onclick="showTab('users')" style="background:var(--accent); color:white; border:none; padding:5px 10px; border-radius:5px;">ØªØ­Ø¯ÙŠØ¯ Ø·Ø§Ù„Ø¨</button>
            </div>

            <input id="nTitle" class="glass-input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±">
            <textarea id="nMsg" class="glass-input" rows="4" placeholder="Ø§ÙƒØªØ¨ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©..."></textarea>
            <button class="main-btn" onclick="sendNotif()">Ø¨Ø« Ø§Ù„Ø¢Ù†</button>
        </div>

        <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø±Ø´ÙŠÙ</h3>
        <div id="notifsList"></div>
    </section>

    <section id="usersSection" class="section">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
            <input type="text" id="userSearch" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹..." oninput="searchUsers()" style="width:150px; padding:8px; border-radius:10px; border:none;">
        </div>
        <div id="userListArea"></div>
    </section>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, deleteDoc, updateDoc, serverTimestamp, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyA4h9MsH0Szht7taowp95WcBr2y6scXe1k", projectId: "omardev-fbfd8" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let usersData = [];
    let selectedId = "all";

    // Menu Logic
    window.openMenu = () => { document.getElementById('bottomSheet').classList.add('active'); document.getElementById('overlay').style.display = 'block'; };
    window.closeMenu = () => { document.getElementById('bottomSheet').classList.remove('active'); document.getElementById('overlay').style.display = 'none'; };
    window.showTab = (tab) => {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(tab + 'Section').classList.add('active');
        closeMenu();
    };

    // Date
    document.getElementById('currentDate').innerText = new Date().toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

    // Platform Lock System
    window.togglePlatform = async () => {
        const statusDoc = doc(db, "settings", "platformStatus");
        const snap = await getDoc(statusDoc);
        const current = snap.exists() ? snap.data().isLocked : false;
        await setDoc(statusDoc, { isLocked: !current });
    };

    onSnapshot(doc(db, "settings", "platformStatus"), (doc) => {
        const isLocked = doc.exists() ? doc.data().isLocked : false;
        const btn = document.getElementById('lockText');
        btn.innerText = isLocked ? "ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù†ØµØ©" : "Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ù†ØµØ©";
    });

    // Users & Search
    onSnapshot(collection(db, "users_azkar"), snap => {
        usersData = snap.docs.map(d => ({id: d.id, ...d.data()}));
        document.getElementById('uCount').innerText = snap.size;
        renderUsers(usersData);
    });

    function renderUsers(list) {
        const area = document.getElementById('userListArea');
        area.innerHTML = list.map(u => `
            <div class="data-card">
                <div class="user-meta">
                    <img src="${u.profilePic || (u.gender === 'Ø£Ù†Ø«Ù‰' ? 'https://cdn-icons-png.flaticon.com/512/6997/6997662.png' : 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png')}">
                    <div><b>${u.firstName} ${u.lastName}</b><br><small>${u.phone}</small></div>
                </div>
                <div style="display:flex; gap:5px;">
                    <button class="badge badge-all" onclick="pickUser('${u.id}', '${u.firstName}')">ØªØ­Ø¯ÙŠØ¯</button>
                    <button class="badge" style="background:var(--danger)" onclick="deleteUser('${u.id}')">Ø­Ø°Ù</button>
                </div>
            </div>
        `).join('');
    }

    window.pickUser = (id, name) => {
        selectedId = id;
        document.getElementById('targetName').innerText = name;
        toggleTargeting();
        showTab('notifs');
    };

    window.toggleTargeting = () => {
        const type = document.getElementById('nType').value;
        document.getElementById('targeting').style.display = (type === 'award') ? 'block' : 'none';
        if(type !== 'award') selectedId = "all";
    };

    // Notifications List
    onSnapshot(query(collection(db, "notifications"), orderBy("timestamp", "desc")), snap => {
        document.getElementById('nCount').innerText = snap.size;
        const list = document.getElementById('notifsList');
        list.innerHTML = snap.docs.map(d => {
            const n = d.data();
            return `
                <div class="data-card">
                    <div>
                        <span class="badge badge-${n.type === 'all'?'all': n.type==='award'?'award':'sys'}">${n.type}</span>
                        <b style="margin-right:10px;">${n.title}</b>
                    </div>
                    <i class="fas fa-trash" style="color:var(--danger); cursor:pointer;" onclick="deleteNotif('${d.id}')"></i>
                </div>
            `;
        }).join('');
    });

window.sendNotif = async () => {
    // 1. Ø¬Ù„Ø¨ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
    const titleInput = document.getElementById('nTitle');
    const msgInput = document.getElementById('nMsg');
    const typeInput = document.getElementById('nType');

    const title = titleInput.value.trim();
    const msg = msgInput.value.trim();
    const type = typeInput.value;

    // 2. Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø®Ø§Ù†Ø§Øª Ù„ÙŠØ³Øª ÙØ§Ø±ØºØ©
    if (!title || !msg) {
        return alert("ÙŠØ§ Ø¹Ù…Ø±ØŒ Ø§Ù„Ø®Ø§Ù†Ø§Øª ÙØ§Ø¶ÙŠØ©! Ø§Ù…Ù„Ø§Ù‡Ø§ Ø§Ù„Ø£ÙˆÙ„ ğŸ—¿");
    }

    try {
        // 3. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        // Ù…Ù„Ø§Ø­Ø¸Ø©: selectedId Ù‡ÙŠÙƒÙˆÙ† "all" Ù„Ùˆ Ù…Ø®ØµØµØªØ´ Ø­Ø¯ØŒ ÙˆÙ‡ÙŠÙƒÙˆÙ† "ID Ø§Ù„Ø·Ø§Ù„Ø¨" Ù„Ùˆ Ø¶ØºØ·Øª ØªØ­Ø¯ÙŠØ¯
        await addDoc(collection(db, "notifications"), { 
            title: title, 
            message: msg, 
            type: type, 
            userId: selectedId, 
            timestamp: serverTimestamp() 
        });

        alert("ØªÙ… Ø§Ù„Ø¨Ø« Ø¨Ù†Ø¬Ø§Ø­ âœ…");

        // 4. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø®Ø§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­
        titleInput.value = "";
        msgInput.value = "";
        
        // 5. Ø¥Ø¹Ø§Ø¯Ø© ØªØµÙÙŠØ± Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± (Ø¹Ø´Ø§Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù„ÙŠ Ø¬Ø§ÙŠ Ù…ÙŠØ±ÙˆØ­Ø´ Ù„Ù†ÙØ³ Ø§Ù„Ø´Ø®Øµ Ø¨Ø§Ù„Ø®Ø·Ø£)
        if (selectedId !== "all") {
            clearTarget(); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ù„ÙŠ Ø¹Ù…Ù„Ù†Ø§Ù‡Ø§ ÙÙˆÙ‚ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯
        }

    } catch (error) {
        console.error("Error sending notification:", error);
        alert("Ø­ØµÙ„Øª Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø¬Ø±Ø¨ ØªØ§Ù†ÙŠ ÙŠØ§ Ø¨Ø·Ù„.");
    }
};

    window.deleteUser = async (id) => { if(confirm("Ø­Ø°ÙØŸ")) await deleteDoc(doc(db, "users_azkar", id)); };
    window.deleteNotif = async (id) => { if(confirm("Ø­Ø°ÙØŸ")) await deleteDoc(doc(db, "notifications", id)); };
    window.logout = () => { localStorage.removeItem('isAdmin'); window.location.href = "login.html"; };
</script>
</body>
</html>